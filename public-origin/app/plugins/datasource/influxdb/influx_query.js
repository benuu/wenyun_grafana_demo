/*! grafana - v2.6.0 - 2015-12-14
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["require","exports","lodash","./query_part"],function(a,b,c,d){var e=function(){function a(a){this.target=a,a.dsType="influxdb",a.resultFormat=a.resultFormat||"time_series",a.tags=a.tags||[],a.groupBy=a.groupBy||[{type:"time",params:["$interval"]},{type:"fill",params:["null"]}],a.select=a.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}return a.prototype.updateProjection=function(){this.selectModels=c.map(this.target.select,function(a){return c.map(a,d.create)}),this.groupByParts=c.map(this.target.groupBy,d.create)},a.prototype.updatePersistedParts=function(){this.target.select=c.map(this.selectModels,function(a){return c.map(a,function(a){return{type:a.def.type,params:a.params}})})},a.prototype.hasGroupByTime=function(){return c.find(this.target.groupBy,function(a){return"time"===a.type})},a.prototype.hasFill=function(){return c.find(this.target.groupBy,function(a){return"fill"===a.type})},a.prototype.addGroupBy=function(a){var b=a.match(/^(\w+)\((.*)\)$/),c=b[1],e=b[2],f=d.create({type:c,params:[e]}),g=this.target.groupBy.length;0===g?this.target.groupBy.push(f.part):"time"===c?this.target.groupBy.splice(0,0,f.part):"tag"===c&&"fill"===this.target.groupBy[g-1].type?this.target.groupBy.splice(g-1,0,f.part):this.target.groupBy.push(f.part),this.updateProjection()},a.prototype.removeGroupByPart=function(a,b){var e=d.getCategories();"time"===a.def.type&&(this.target.groupBy=c.filter(this.target.groupBy,function(a){return"fill"!==a.type}),this.target.select=c.map(this.target.select,function(a){return c.filter(a,function(a){var b=d.create(a);return b.def.category===e.Aggregations?!1:b.def.category===e.Selectors?!1:!0})})),this.target.groupBy.splice(b,1),this.updateProjection()},a.prototype.removeSelect=function(a){this.target.select.splice(a,1),this.updateProjection()},a.prototype.removeSelectPart=function(a,b){if("field"===b.def.type){if(this.selectModels.length>1){var d=c.indexOf(this.selectModels,a);this.selectModels.splice(d,1)}}else{var e=c.indexOf(a,b);a.splice(e,1)}this.updatePersistedParts()},a.prototype.addSelectPart=function(a,b){var c=d.create({type:b});c.def.addStrategy(a,c,this),this.updatePersistedParts()},a.prototype.renderTagCondition=function(a,b){var c="",d=a.operator,e=a.value;return b>0&&(c=(a.condition||"AND")+" "),d||(d=/^\/.*\/$/.test(a.value)?"=~":"="),"=~"!==d&&"!~"!==d&&(e="'"+e+"'"),c+'"'+a.key+'" '+d+" "+e},a.prototype.render=function(){var a=this,b=this.target;if(b.rawQuery)return b.query;if(!b.measurement)throw"Metric measurement is missing";var d,e,f="SELECT ";for(d=0;d<this.selectModels.length;d++){var g=this.selectModels[d],h="";for(e=0;e<g.length;e++){var i=g[e];h=i.render(h)}d>0&&(f+=", "),f+=h}var j=b.measurement;j.match("^/.*/")||j.match(/^merge\(.*\)/)||(j='"'+j+'"'),f+=" FROM "+j+" WHERE ";var k=c.map(b.tags,function(b,c){return a.renderTagCondition(b,c)});f+=k.join(" "),f+=(k.length>0?" AND ":"")+"$timeFilter";var l="";for(d=0;d<this.groupByParts.length;d++){var m=this.groupByParts[d];d>0&&(l+="fill"===m.def.type?" ":", "),l+=m.render("")}return l.length&&(f+=" GROUP BY "+l),b.fill&&(f+=" fill("+b.fill+")"),b.query=f,f},a}();return e});