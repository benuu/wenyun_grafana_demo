/*! grafana - v2.6.0 - 2015-12-14
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["require","exports","lodash"],function(a,b,c){function d(a,b){var d=a.def.type+"(",e=c.map(a.params,function(b,c){var d=a.def.params[c];return"time"===d.type&&"auto"===b&&(b="$interval"),"single"===d.quote?"'"+b+"'":"double"===d.quote?'"'+b+'"':b});return b&&e.unshift(b),d+e.join(", ")+")"}function e(a,b){return b+' AS "'+a.params[0]+'"'}function f(a,b){return b+" "+a.params[0]}function g(a){return"*"===a.params[0]?"*":'"'+a.params[0]+'"'}function h(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.def.category===n.Aggregations)return void(a[c]=b);if(d.def.category===n.Selectors)return void(a[c]=b)}a.splice(1,0,b)}function i(a,b){var c;for(c=0;c<a.length;c++){var d=a[c];if(d.def.category===n.Math||d.def.category===n.Aliasing)break}a.splice(c,0,b)}function j(a,b){var c=a.length;if(c>0){if("math"===a[c-1].def.type)return void(a[c-1]=b);if("math"===a[c-2].def.type)return void(a[c-2]=b);if("alias"===a[c-1].def.type)return void a.splice(c-1,0,b)}a.push(b)}function k(a,b){var c=a.length;return c>0&&"alias"===a[c-1].def.type?void(a[c-1]=b):void a.push(b)}function l(a,b,d){var e=c.map(a,function(a){return new q({type:a.def.type,params:c.clone(a.params)})});d.selectModels.push(e)}var m=[],n={Aggregations:[],Selectors:[],Transformations:[],Math:[],Aliasing:[],Fields:[]},o=[],p=function(){function a(a){this.type=a.type,this.params=a.params,this.defaultParams=a.defaultParams,this.renderer=a.renderer,this.category=a.category,this.addStrategy=a.addStrategy}return a.register=function(b){m[b.type]=new a(b),b.category.push(m[b.type])},a}();p.register({type:"field",addStrategy:l,category:n.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:g}),p.register({type:"count",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"distinct",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"integral",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"mean",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"median",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"sum",addStrategy:h,category:n.Aggregations,params:[],defaultParams:[],renderer:d}),p.register({type:"derivative",addStrategy:i,category:n.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:d}),p.register({type:"non_negative_derivative",addStrategy:i,category:n.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:d}),p.register({type:"stddev",addStrategy:i,category:n.Transformations,params:[],defaultParams:[],renderer:d}),p.register({type:"time",category:o,params:[{name:"interval",type:"time",options:["auto","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["auto"],renderer:d}),p.register({type:"fill",category:o,params:[{name:"fill",type:"string",options:["none","null","0","previous"]}],defaultParams:["null"],renderer:d}),p.register({type:"bottom",addStrategy:h,category:n.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:d}),p.register({type:"first",addStrategy:h,category:n.Selectors,params:[],defaultParams:[],renderer:d}),p.register({type:"last",addStrategy:h,category:n.Selectors,params:[],defaultParams:[],renderer:d}),p.register({type:"max",addStrategy:h,category:n.Selectors,params:[],defaultParams:[],renderer:d}),p.register({type:"min",addStrategy:h,category:n.Selectors,params:[],defaultParams:[],renderer:d}),p.register({type:"percentile",addStrategy:h,category:n.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:d}),p.register({type:"top",addStrategy:h,category:n.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:d}),p.register({type:"tag",category:o,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:g}),p.register({type:"math",addStrategy:j,category:n.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:f}),p.register({type:"alias",addStrategy:k,category:n.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:e});var q=function(){function a(a){if(this.part=a,this.def=m[a.type],!this.def)throw{message:"Could not find query part "+a.type};a.params=a.params||c.clone(this.def.defaultParams),this.params=a.params,this.updateText()}return a.prototype.render=function(a){return this.def.renderer(this,a)},a.prototype.hasMultipleParamsInString=function(a,b){return-1===a.indexOf(",")?!1:this.def.params[b+1]&&this.def.params[b+1].optional},a.prototype.updateParam=function(a,b){return this.hasMultipleParamsInString(a,b)?void c.each(a.split(","),function(a,b){this.updateParam(a.trim(),b)},this):(""===a&&this.def.params[b].optional?this.params.splice(b,1):this.params[b]=a,this.part.params=this.params,void this.updateText())},a.prototype.updateText=function(){if(0===this.params.length)return void(this.text=this.def.type+"()");var a=this.def.type+"(";a+=this.params.join(", "),a+=")",this.text=a},a}();return{create:function(a){return new q(a)},getCategories:function(){return n}}});