/*! grafana - v2.6.0 - 2015-12-14
 * Copyright (c) 2015 Torkel Ã–degaard; Licensed Apache-2.0 */

define(["angular","lodash","./editorCtrl"],function(a,b){"use strict";var c=a.module("grafana.services");c.service("annotationsSrv",["$rootScope","$q","datasourceSrv","alertSrv","timeSrv",function(a,c,d,e,f){function g(a){console.log("Annotation error: ",a);var b=a.message||"Annotation query failed";e.set("Annotations error",b,"error")}var h,i=[],j=this;this.init=function(){a.onAppEvent("refresh",this.clearCache,a),a.onAppEvent("dashboard-loaded",this.clearCache,a)},this.clearCache=function(){h=null,i=[]},this.getAnnotations=function(a){if(0===a.annotations.list.length)return c.when(null);if(h)return h;j.dashboard=a;var e=b.where(a.annotations.list,{enable:!0}),k=f.timeRange(),l=f.timeRange(!1),m=b.map(e,function(a){return d.get(a.datasource).then(function(b){var c={range:k,rangeRaw:l,annotation:a};return b.annotationQuery(c).then(j.receiveAnnotationResults).then(null,g)},this)});return h=c.all(m).then(function(){return i})},this.receiveAnnotationResults=function(a){for(var b=0;b<a.length;b++)j.addAnnotation(a[b])},this.addAnnotation=function(a){i.push({annotation:a.annotation,min:a.time,max:a.time,eventType:a.annotation.name,title:a.title,tags:a.tags,text:a.text,score:1})},this.init()}])});